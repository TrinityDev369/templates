# =============================================================================
# rate-limiting.conf — Rate Limiting Zones and Configuration
# =============================================================================
# Protects against abuse, brute-force attacks, and DDoS.
# Defines three zones with different limits for different endpoint types.
#
# Zone usage:
#   - general: All standard page requests (10 req/s)
#   - api:     API endpoints (30 req/s)
#   - auth:    Login, registration, password reset (5 req/s)
#
# Apply zones in location blocks with: limit_req zone=NAME burst=N nodelay;
# =============================================================================

# -----------------------------------------------------------------------------
# Rate limiting zones — defined by client IP ($binary_remote_addr)
# -----------------------------------------------------------------------------
# Zone memory: 10m ~ 160,000 unique IPs (each key = ~64 bytes)

# General requests — 10 requests per second per IP
# Suitable for page loads, navigation, general browsing
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

# API requests — 30 requests per second per IP
# Higher limit for API-heavy single-page applications
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;

# Auth requests — 5 requests per second per IP
# Strict limit to prevent brute-force login attempts
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;

# -----------------------------------------------------------------------------
# Rate limit response settings
# -----------------------------------------------------------------------------

# Return 429 (Too Many Requests) when rate limit is exceeded
# Default is 503, but 429 is semantically correct
limit_req_status 429;

# Log rate-limited requests at warn level (not error)
limit_req_log_level warn;

# -----------------------------------------------------------------------------
# Custom 429 error response
# -----------------------------------------------------------------------------
# The actual error page is defined in default.conf's error_page directive.
# Clients receive a clear message about rate limiting with Retry-After header.

# Note: To add a Retry-After header, use this in your 429 location block:
# add_header Retry-After 60 always;
