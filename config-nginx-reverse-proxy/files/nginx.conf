# =============================================================================
# nginx.conf — Main Nginx Configuration
# =============================================================================
# Production-ready main config for Nginx reverse proxy.
# Includes modular conf.d/ files for SSL, security, rate limiting, and caching.
# =============================================================================

# Run as the nginx user (default in official Docker image)
user  nginx;

# Automatically detect the number of CPU cores
worker_processes  auto;

# Error log — warn level is a good production default
error_log  /var/log/nginx/error.log warn;

# PID file location
pid        /var/run/nginx.pid;

# -----------------------------------------------------------------------------
# Events
# -----------------------------------------------------------------------------
events {
    # Max simultaneous connections per worker
    worker_connections  1024;

    # Use epoll on Linux for better performance
    use  epoll;

    # Accept multiple connections at once
    multi_accept  on;
}

# -----------------------------------------------------------------------------
# HTTP
# -----------------------------------------------------------------------------
http {
    # MIME types
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # -------------------------------------------------------------------------
    # Logging — structured JSON format for log aggregation
    # -------------------------------------------------------------------------
    log_format  main_json  escape=json
        '{'
            '"time":"$time_iso8601",'
            '"remote_addr":"$remote_addr",'
            '"request":"$request",'
            '"status":$status,'
            '"body_bytes_sent":$body_bytes_sent,'
            '"request_time":$request_time,'
            '"upstream_response_time":"$upstream_response_time",'
            '"http_referer":"$http_referer",'
            '"http_user_agent":"$http_user_agent",'
            '"http_x_forwarded_for":"$http_x_forwarded_for",'
            '"request_id":"$request_id"'
        '}';

    access_log  /var/log/nginx/access.log  main_json;

    # -------------------------------------------------------------------------
    # Performance
    # -------------------------------------------------------------------------

    # Efficient file transfer — skip userspace copy
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;

    # Keepalive
    keepalive_timeout  65;
    keepalive_requests 100;

    # Buffer sizes
    client_body_buffer_size    16k;
    client_header_buffer_size  1k;
    large_client_header_buffers 4 8k;
    client_max_body_size       50m;

    # Timeouts
    client_body_timeout    12;
    client_header_timeout  12;
    send_timeout           10;

    # Hide Nginx version in response headers
    server_tokens  off;

    # -------------------------------------------------------------------------
    # Gzip Compression
    # -------------------------------------------------------------------------
    gzip             on;
    gzip_vary        on;
    gzip_proxied     any;
    gzip_comp_level  6;
    gzip_min_length  256;
    gzip_buffers     16 8k;
    gzip_http_version 1.1;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/x-javascript
        application/xml
        application/xml+rss
        application/atom+xml
        application/rss+xml
        application/vnd.ms-fontobject
        font/opentype
        font/ttf
        image/svg+xml
        image/x-icon;

    # -------------------------------------------------------------------------
    # Request ID — unique identifier for each request (tracing)
    # -------------------------------------------------------------------------
    map $http_x_request_id $request_id {
        default   $http_x_request_id;
        ""        $request_id;
    }

    # -------------------------------------------------------------------------
    # WebSocket upgrade mapping
    # -------------------------------------------------------------------------
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # -------------------------------------------------------------------------
    # Rate limiting zones (must be at http level)
    # -------------------------------------------------------------------------
    include /etc/nginx/conf.d/rate-limiting.conf;

    # -------------------------------------------------------------------------
    # Proxy cache paths (must be at http level)
    # -------------------------------------------------------------------------
    include /etc/nginx/conf.d/caching.conf;

    # -------------------------------------------------------------------------
    # Server blocks
    # -------------------------------------------------------------------------
    include /etc/nginx/conf.d/default.conf;
}
